import{$ as it,J as ot,Z as st,_ as rt,aa as at,ba as ct,c as tt,d as et,e as nt,ja as I,ka as ut,la as lt,ma as dt,na as pt}from"./chunk-OE3E2UNB.js";import{Eb as Q,Fb as W,Gb as Y,Hb as j,Ib as R,Mc as Z,Rb as $,bc as J,cb as D,cc as H,ea as T,fb as P,g as p,gc as K,ka as q,kb as z,na as k,xb as A}from"./chunk-NV65B5NU.js";var N=class{};function Et(n,o="data.zip"){let s=document.createElement("a"),t=URL.createObjectURL(n);s.href=t,s.download=o,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(t)}function O(n,o){let s=JSON.stringify(n),e=o.split(".").pop()===o?`${o}.json`:o;return b(s,e,"text/json")}function b(n,o,s="text/plain"){let t=new Blob([n],{type:s});return Et(t,o)}function V(n){return p(this,null,function*(){return new Promise((o,s)=>{let t=document.createElement("input");t.style.display="none",t.setAttribute("type","file"),n!==void 0&&t.setAttribute("accept",n),document.body.appendChild(t),t.click(),t.addEventListener("change",e=>{let r=e.target?.files[0];t.remove(),r&&o(r),s()})})})}function ft(n=".json,.JSON"){return p(this,null,function*(){let o=yield V(n);return new Promise((s,t)=>{let e=new FileReader;e.readAsText(o),e.onload=()=>{let r=e.result;(typeof r=="string"||r instanceof String)&&s(JSON.parse(r)),t("Not a string")},e.onerror=()=>{t("File read failed")}})})}function mt(n,o,s=1){return p(this,null,function*(){return new Promise(t=>{let e=[],r=[],i=null;n.bbox!==void 0&&o.bbox!==void 0&&(i=Gt([n.bbox,o.bbox]));let a=ht(n,i,s),c=ht(o,i,s);for(let l of a){let u=null,d=1/0,f=l.geometry.coordinates;for(let h of c){let y=h.geometry.coordinates,g=At(f,y);g<d&&(d=g,u=h)}if(d<=s&&u){let h={type:"Feature",geometry:{type:"LineString",coordinates:[f,u.geometry.coordinates]},properties:{distance:d,connectingPoint:l.properties,connectedPoint:u.properties}};e.push({featureA:l,featureB:u,distance:d,connection:h})}else r.push(l)}t({successful:e,unsuccesful:r,threshold:s})})})}function Gt(n){if(!n.length)return null;let o=-1/0,s=-1/0,t=1/0,e=1/0;for(let r of n)o=Math.max(o,r[0]),s=Math.max(s,r[1]),t=Math.min(t,r[2]),e=Math.min(e,r[3]);return o>t||s>e?null:[o,s,t,e]}function gt(n,o,s=1){let[t,e]=n,[r,i,a,c]=o,l=r-s/(111132*Math.cos(Math.PI*(i/180))),u=i-s/111132,d=a+s/(111132*Math.cos(Math.PI*(i/180))),f=c+s/111132;return t>=l&&t<=d&&e>=u&&e<=f}function Mt(n){return p(this,null,function*(){return new Promise(o=>{let s=1/0,t=1/0,e=-1/0,r=-1/0;for(let i of n)s=Math.min(s,i[0]),t=Math.min(t,i[1]),e=Math.max(e,i[0]),r=Math.max(r,i[1]);o([s,t,e,r])})})}function At(n,o){let[s,t]=n,[e,r]=o,i=6371e3,a=L(t),c=L(r),l=L(r-t),u=L(e-s),d=Math.sin(l/2)*Math.sin(l/2)+Math.cos(a)*Math.cos(c)*Math.sin(u/2)*Math.sin(u/2),f=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d));return i*f}function ht(n,o=null,s=0){let t=n.features.filter(e=>e.geometry.type.toLowerCase()==="point").filter(e=>e.geometry.coordinates!==void 0).filter(e=>o?gt(e.geometry.coordinates,o,s):!0);return t===void 0?[]:t}function re(n,o=null,s=0){return n.features=n.features.filter(t=>t.geometry.type.toLowerCase()==="point").filter(t=>t.geometry.coordinates!==void 0).filter(t=>o?gt(t.geometry.coordinates,o,s):!0)??[],n}function L(n){return n*Math.PI/180}function wt(n,o){return{type:"Feature",geometry:{type:"Point",coordinates:n},properties:o}}function U(n,o=!0){return p(this,null,function*(){let s={type:"FeatureCollection",features:n};if(o){let t=[];n.forEach(e=>{e.geometry.coordinates!==void 0&&t.push(e.geometry.coordinates)}),s.bbox=yield Mt(t)}return s})}function Vt(n,o){if(n&1&&(j(0,"mat-option",2),J(1),R()),n&2){let s=o.$implicit;A("value",s.value),P(),H(s.label)}}var _=function(n){return n.LV03="SwissGrid LV03",n.LV95="SwissGrid LV95",n}(_||{}),Ie=(()=>{let o=class o{constructor(){this.crsOptions=Object.values(_).map(t=>({value:t,label:t.toString()})),this.selectedOption=_.LV95,this.selectedCRS=new z,this.selectedCRS.emit(_.LV95)}};o.\u0275fac=function(e){return new(e||o)},o.\u0275cmp=k({type:o,selectors:[["app-crs-select"]],outputs:{selectedCRS:"selectedCRS"},standalone:!0,features:[K],decls:6,vars:1,consts:[[2,"width","100%"],[3,"ngModel","ngModelChange","selectionChange"],[3,"value"]],template:function(e,r){e&1&&(j(0,"mat-form-field",0)(1,"mat-label"),J(2,"CRS"),R(),j(3,"mat-select",1),$("ngModelChange",function(a){return r.selectedOption=a})("selectionChange",function(){return r.selectedCRS.emit(r.selectedOption)}),W(4,Vt,2,2,"mat-option",2,Q),R()()),e&2&&(P(3),A("ngModel",r.selectedOption),P(),Y(r.crsOptions))},dependencies:[Z,ct,rt,st,at,ot,it,nt,tt,et]});let n=o;return n})();function B(n){if(!Array.isArray(n))throw new Error("Expected input to be an array.");if(n.length<2)throw new Error("Expected input to be an array with length >= 2, got "+n.length+".");if(n.some(function(o){return!Number.isFinite(o)}))throw new Error("Expected all coordinates to be finite numbers.")}function yt(n,o,s){return(s/60+o)/60+n}function X(n){return 180*n/Math.PI}function v(n){return n*Math.PI/180}function _t(n,o){return{apply:function(s){var t=s[0],e=s[1],r=s.slice(2);return[t+n,e+o].concat(r)},unapply:function(s){var t=s[0],e=s[1],r=s.slice(2);return[t-n,e-o].concat(r)}}}Number.isFinite===void 0&&(Number.isFinite=function(n){return typeof n=="number"&&isFinite(n)});var bt=_t(6e5,2e5),Bt=bt.apply,Tt=bt.unapply;var Ft=_t(26e5,12e5),De=Ft.apply,qt=Ft.unapply;function vt(n,o){var s=1/o,t=2*s-Math.pow(s,2);return{fromCartesian:function(e){var r,i,a,c,l,u=e[0],d=e[1],f=e[2],h=Math.atan(d/u),y=Math.sqrt(Math.pow(u,2)+Math.pow(d,2)),g=Math.atan(f/((1-t)*y));do r=i,a=c,c=n/Math.sqrt(1-t*Math.pow(Math.sin(g),2)),l=y/Math.cos(g)-c,g=Math.atan(f/((1-t*c/(c+l))*y)),i=Math.abs(c-a);while(isNaN(r)||i<r);var S=X(g);return[X(h),S,l]},toCartesian:function(e){var r=e[0],i=e[2],a=i===void 0?0:i,c=v(e[1]),l=v(r),u=n/Math.sqrt(1-t*Math.pow(Math.sin(c),2));return[(u+a)*Math.cos(c)*Math.cos(l),(u+a)*Math.cos(c)*Math.sin(l),(u*(1-t)+a)*Math.sin(c)]}}}var St=vt(6377397155e-3,299.15281285),kt=St.fromCartesian,zt=St.toCartesian,It=vt(6378137,298.257223563),Qt=It.fromCartesian,Wt=It.toCartesian,xt=1/299.15281285,F=v(yt(46,57,8.66)),Ct=v(yt(7,26,22.5)),C=2*xt-Math.pow(xt,2),E=6377397155e-3*Math.sqrt(1-C)/(1-C*Math.pow(Math.sin(F),2)),w=Math.sqrt(1+C/(1-C)*Math.pow(Math.cos(F),4)),M=Math.asin(Math.sin(F)/w),x=Math.sqrt(C),Dt=Math.log(Math.tan(Math.PI/4+M/2))-w*Math.log(Math.tan(Math.PI/4+F/2))+w*x/2*Math.log((1+x*Math.sin(F))/(1-x*Math.sin(F)));function Yt(n){var o,s=[(o=Wt(n))[0]-674.374,o[1]-15.056,o[2]-405.346],t=kt(s),e=function(r){var i=r[0],a=v(r[1]),c=v(i),l=w*Math.log(Math.tan(Math.PI/4+a/2))-w*x/2*Math.log((1+x*Math.sin(a))/(1-x*Math.sin(a)))+Dt,u=2*(Math.atan(Math.exp(l))-Math.PI/4),d=w*(c-Ct),f=Math.asin(Math.cos(M)*Math.sin(u)-Math.sin(M)*Math.cos(u)*Math.cos(d)),h=Math.atan(Math.sin(d)/(Math.sin(M)*Math.tan(u)+Math.cos(M)*Math.cos(d)));return[E*h,E/2*Math.log((1+Math.sin(f))/(1-Math.sin(f)))]}(t);return n.length>2?[].concat(e,[t[2]]):e}function Pt(n){var o=function(r){var i,a,c,l,u=r[0],d=2*(Math.atan(Math.exp(r[1]/E))-Math.PI/4),f=u/E,h=Math.asin(Math.cos(M)*Math.sin(d)+Math.sin(M)*Math.cos(d)*Math.cos(f)),y=Math.atan(Math.sin(f)/(Math.cos(M)*Math.cos(f)-Math.sin(M)*Math.tan(d))),g=Ct+y/w,S=h;do i=a,c=l,l=(Math.log(Math.tan(Math.PI/4+h/2))-Dt)/w+x*Math.log(Math.tan(Math.PI/4+Math.asin(x*Math.sin(S))/2)),S=2*Math.atan(Math.exp(l))-Math.PI/2,a=Math.abs(l-c);while(isNaN(i)||a<i);var Xt=X(S);return[X(g),Xt]}(n);o.push(n[2]);var s,t=[(s=zt(o))[0]+674.374,s[1]+15.056,s[2]+405.346],e=Qt(t);return n.length>2?e:e.slice(0,2)}var jt={__proto__:null,project:function(n){return B(n),Bt(Yt(n))},unproject:function(n){return B(n),Pt(Tt(n))}};function $t(n){return B(n),Pt(qt(n))}var Rt=$t;function Nt(n,o){let[s,t]=Rt([n,o]);return{latitude:t,longitude:s}}function Ot(n,o){let[s,t]=jt.unproject([n,o]);return{latitude:t,longitude:s}}var{namedNode:m,literal:G,defaultGraph:Ee,quad:Ge}=lt,Lt=m("http://www.w3.org/1999/02/22-rdf-syntax-ns#type");function Ut(n,o="https://www.stadt-zuerich.ch/resources/"){return p(this,null,function*(){let s={inst:o,cz:"https://www.stadt-zuerich.ch/terms#",geo:"http://www.opengis.net/ont/geosparql#",wgs:"http://www.w3.org/2003/01/geo/wgs84_pos#"},t=new dt({prefixes:s});for(let e of n.features){let r=JSON.stringify(e),a=(e.properties??{}).baumnummer;a!==void 0&&(r=`tree_${a}`);let l=`inst:${yield I(r)}`;t.addQuad(m(l),Lt,m("cz:Tree")),e.id!==void 0&&t.addQuad(m(l),m("cz:id"),G(e.id)),a!==void 0&&t.addQuad(m(l),m("cz:treeNumber"),G(a));let u=e.geometry;if(u!==void 0){let f=`inst:${yield I(`${r}_geo`)}`;t.addQuad(m(f),Lt,m("geo:Geometry")),t.addQuad(m(l),m("geo:hasGeometry"),m(f));let h=u.coordinates;h!==void 0&&h.length&&(t.addQuad(m(f),m("wgs:lng"),G(h[0])),t.addQuad(m(f),m("wgs:lat"),G(h[1])))}}return new Promise((e,r)=>{t.end((i,a)=>{i&&r(i),e(a)})})})}var tn=(()=>{let o=class o{constructor(){this._dxfProcessor=q(pt),this._results=D(new N),this._resultsUpdated=D(0),this._processing=D(!1),this._tripleNamespace="https://www.stadt-zuerich.ch/resources/"}get results(){return this._results}get resultsUpdated(){return this._resultsUpdated}get processing(){return this._processing}set gisFeaturesSubset(t){let e=this._results();e.gisFeaturesSubset=t,this._updateResults(e)}setDXFSelection(t,e){return p(this,null,function*(){this._processing.set(!0);let r=yield this._buildGeoJSON(t,e),i=this._results();i.dxfFeatures=r,i.subsetDXF=this._dxfProcessor.extractSubset(t),i.dxfEntities=t,i.subsetDXFURL=this._createObjectURLFromString(i.subsetDXF),this._updateResults(i),this._processing.set(!1)})}uploadDXF(t=!0){return p(this,null,function*(){t&&console.time("Process DXF");let e=yield V(".dxf");this._processing.set(!0);let[r,i]=yield Promise.all([this._dxfProcessor.processDXF(e),ut(e)]),a=yield I(i),c=this._results();c.fullDXF=r,c.dxfMD5=i,c.dxfUUID=a,this._updateResults(c),t&&console.timeEnd("Process DXF"),this._processing.set(!1)})}uploadGeoJSON(){return p(this,null,function*(){let t=yield ft(".json,.geojson");this._processing.set(!0);let e=this._results();e.gisFeatures=t,this._updateResults(e),this._processing.set(!1)})}matchDXFGisFeatures(t=1){return p(this,null,function*(){this._processing.set(!0);let e=this._results().dxfFeatures,r=this._results().gisFeatures;if(e===void 0){console.error("No DXF features available");return}if(r===void 0){console.error("No GIS features available");return}let i=yield mt(e,r,t),a=this._results();return a.pairingResults=i,this._updateResults(a),this._processing.set(!1),i})}downloadSubsetDXF(){this._processing.set(!0);let t=this._results().subsetDXF;if(t===void 0){console.error("No DXF available");return}b(t,"selection.dxf"),this._processing.set(!1)}downloadSelectedDXFAsGeoJSON(){return p(this,null,function*(){this._processing.set(!0);let t=this._results().dxfFeatures;if(t===void 0){console.error("No geoJSON from DXF available");return}O(t,"selection.geojson"),this._processing.set(!1)})}downloadDXFSubsetRDF(){return p(this,null,function*(){this._processing.set(!0);let t=this._results().dxfEntities,e=this._results().dxfUUID;if(t===void 0){console.error("No DXF selection available");return}if(e===void 0){console.error("DXF UUID not available");return}let r=yield this._dxfProcessor.buildASCollection(t,e,this._tripleNamespace);b(r,"dxf-subset.rdf"),this._processing.set(!1)})}downloadDXFTextsRDF(){return p(this,null,function*(){this._processing.set(!0);let t=this._results().dxfUUID;if(t===void 0){console.error("DXF UUID not available");return}let e=yield this._dxfProcessor.extractTextContent(t,this._tripleNamespace);b(e,"dxf-text.ttl"),this._processing.set(!1)})}downloadGISAsRDF(){return p(this,null,function*(){this._processing.set(!0);let t=this._results().gisFeatures;if(t===void 0){console.error("No geoJSON available");return}let e=yield Ut(t,this._tripleNamespace);b(e,"trees.ttl"),this._processing.set(!1)})}downloadMappings(){return p(this,null,function*(){let t=this._results().pairingResults;if(t===void 0){console.error("Pairing results not available");return}this._processing.set(!0);let e=t.successful.map(i=>i.connection),r=yield U(e,!1);r.properties={mappingDistance:t.threshold},O(r,"mapped.geojson"),this._processing.set(!1)})}downloadUnmapped(){return p(this,null,function*(){let t=this._results().pairingResults;if(t===void 0){console.error("Pairing results not available");return}this._processing.set(!0);let e=yield U(t.unsuccesful);e.properties={mappingDistance:t.threshold},O(e,"unmapped.geojson"),this._processing.set(!1)})}_buildGeoJSON(t,e){return p(this,null,function*(){let r=[];return t.forEach(i=>{if(i.position!==void 0){let a=0,c=0;if(e===_.LV95){let u=Nt(i.position.x,i.position.y);a=u.latitude,c=u.longitude}else if(e===_.LV03){let u=Ot(i.position.x,i.position.y);a=u.latitude,c=u.longitude}let l=wt([c,a],i);r.push(l)}}),U(r)})}_updateResults(t){this._results.set(t),this._resultsUpdated.set(new Date().getMilliseconds())}_createObjectURLFromString(t,e="subset.dxf"){let r=new Blob([t],{type:"text/plain"});return URL.createObjectURL(r)}};o.\u0275fac=function(e){return new(e||o)},o.\u0275prov=T({token:o,factory:o.\u0275fac,providedIn:"root"});let n=o;return n})();export{_ as a,Ie as b,b as c,Gt as d,re as e,tn as f};
