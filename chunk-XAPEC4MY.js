import{$ as rt,J as ot,_ as st,aa as it,ba as at,c as tt,ca as ct,d as et,e as nt,ka as I,la as ut,ma as lt,na as dt,oa as ft}from"./chunk-2WNVXLRE.js";import{Gb as Y,Hb as Q,Ib as W,Jb as R,Kb as j,Oc as Z,Tb as $,cb as D,dc as B,ea as T,ec as H,fb as P,g as f,ic as K,ka as q,kb as z,na as k,zb as A}from"./chunk-BPNMUSLZ.js";var N=class{};function Gt(n,o="data.zip"){let s=document.createElement("a"),t=URL.createObjectURL(n);s.href=t,s.download=o,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(t)}function O(n,o){let s=JSON.stringify(n),e=o.split(".").pop()===o?`${o}.json`:o;return _(s,e,"text/json")}function _(n,o,s="text/plain"){let t=new Blob([n],{type:s});return Gt(t,o)}function J(n){return f(this,null,function*(){return new Promise((o,s)=>{let t=document.createElement("input");t.style.display="none",t.setAttribute("type","file"),n!==void 0&&t.setAttribute("accept",n),document.body.appendChild(t),t.click(),t.addEventListener("change",e=>{let r=e.target?.files[0];t.remove(),r&&o(r),s()})})})}function pt(n=".json,.JSON"){return f(this,null,function*(){let o=yield J(n);return new Promise((s,t)=>{let e=new FileReader;e.readAsText(o),e.onload=()=>{let r=e.result;(typeof r=="string"||r instanceof String)&&s(JSON.parse(r)),t("Not a string")},e.onerror=()=>{t("File read failed")}})})}function mt(n,o,s=1){return f(this,null,function*(){return new Promise(t=>{let e=[],r=[],i=null;n.bbox!==void 0&&o.bbox!==void 0&&(i=At([n.bbox,o.bbox]));let a=ht(n,i,s),u=ht(o,i,s);for(let c of a){let l=null,d=1/0,p=c.geometry.coordinates;for(let h of u){let x=h.geometry.coordinates,M=Bt(p,x);M<d&&(d=M,l=h)}if(d<=s&&l){let h={type:"Feature",geometry:{type:"LineString",coordinates:[p,l.geometry.coordinates]},properties:{distance:d,connectingPoint:c.properties,connectedPoint:l.properties}};e.push({featureA:c,featureB:l,distance:d,connection:h})}else r.push(c)}t({successful:e,unsuccesful:r,threshold:s})})})}function At(n){if(!n.length)return null;let o=-1/0,s=-1/0,t=1/0,e=1/0;for(let r of n)o=Math.max(o,r[0]),s=Math.max(s,r[1]),t=Math.min(t,r[2]),e=Math.min(e,r[3]);return o>t||s>e?null:[o,s,t,e]}function Mt(n,o,s=1){let[t,e]=n,[r,i,a,u]=o,c=r-s/(111132*Math.cos(Math.PI*(i/180))),l=i-s/111132,d=a+s/(111132*Math.cos(Math.PI*(i/180))),p=u+s/111132;return t>=c&&t<=d&&e>=l&&e<=p}function gt(n){return f(this,null,function*(){return new Promise(o=>{let s=1/0,t=1/0,e=-1/0,r=-1/0;for(let i of n)s=Math.min(s,i[0]),t=Math.min(t,i[1]),e=Math.max(e,i[0]),r=Math.max(r,i[1]);o([s,t,e,r])})})}function Bt(n,o){let[s,t]=n,[e,r]=o,i=6371e3,a=X(t),u=X(r),c=X(r-t),l=X(e-s),d=Math.sin(c/2)*Math.sin(c/2)+Math.cos(a)*Math.cos(u)*Math.sin(l/2)*Math.sin(l/2),p=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d));return i*p}function ht(n,o=null,s=0){let t=n.features.filter(e=>e.geometry.type.toLowerCase()==="point").filter(e=>e.geometry.coordinates!==void 0).filter(e=>o?Mt(e.geometry.coordinates,o,s):!0);return t===void 0?[]:t}function ie(n,o=null,s=0){return n.features=n.features.filter(t=>t.geometry.type.toLowerCase()==="point").filter(t=>t.geometry.coordinates!==void 0).filter(t=>o?Mt(t.geometry.coordinates,o,s):!0)??[],n}function X(n){return n*Math.PI/180}function wt(n,o){return{type:"Feature",geometry:{type:"Point",coordinates:n},properties:o}}function L(n,o=!0){return f(this,null,function*(){let s={type:"FeatureCollection",features:n};if(o){let t=[];n.forEach(e=>{e.geometry.coordinates!==void 0&&t.push(e.geometry.coordinates)}),s.bbox=yield gt(t)}return s})}function yt(n){let o=1/0,s=1/0,t=-1/0,e=-1/0,r=n.features;for(let i of r)if(i.geometry.type==="Point"){let a=i.geometry.coordinates;if(a===void 0)continue;let u=Array.isArray(a[0])?a:[a];for(let c of u)o=Math.min(o,c[0]),s=Math.min(s,c[1]),t=Math.max(t,c[0]),e=Math.max(e,c[1])}return o===1/0?null:[o,s,t,e]}function Vt(n,o){if(n&1&&(R(0,"mat-option",2),B(1),j()),n&2){let s=o.$implicit;A("value",s.value),P(),H(s.label)}}var b=function(n){return n.LV03="SwissGrid LV03",n.LV95="SwissGrid LV95",n}(b||{}),Ce=(()=>{let o=class o{constructor(){this.crsOptions=Object.values(b).map(t=>({value:t,label:t.toString()})),this.selectedOption=b.LV95,this.selectedCRS=new z,this.selectedCRS.emit(b.LV95)}};o.\u0275fac=function(e){return new(e||o)},o.\u0275cmp=k({type:o,selectors:[["app-crs-select"]],outputs:{selectedCRS:"selectedCRS"},standalone:!0,features:[K],decls:6,vars:1,consts:[[2,"width","100%"],[3,"ngModel","ngModelChange","selectionChange"],[3,"value"]],template:function(e,r){e&1&&(R(0,"mat-form-field",0)(1,"mat-label"),B(2,"CRS"),j(),R(3,"mat-select",1),$("ngModelChange",function(a){return r.selectedOption=a})("selectionChange",function(){return r.selectedCRS.emit(r.selectedOption)}),Q(4,Vt,2,2,"mat-option",2,Y),j()()),e&2&&(P(3),A("ngModel",r.selectedOption),P(),W(r.crsOptions))},dependencies:[Z,ct,rt,st,at,ot,it,nt,tt,et]});let n=o;return n})();function V(n){if(!Array.isArray(n))throw new Error("Expected input to be an array.");if(n.length<2)throw new Error("Expected input to be an array with length >= 2, got "+n.length+".");if(n.some(function(o){return!Number.isFinite(o)}))throw new Error("Expected all coordinates to be finite numbers.")}function bt(n,o,s){return(s/60+o)/60+n}function U(n){return 180*n/Math.PI}function v(n){return n*Math.PI/180}function _t(n,o){return{apply:function(s){var t=s[0],e=s[1],r=s.slice(2);return[t+n,e+o].concat(r)},unapply:function(s){var t=s[0],e=s[1],r=s.slice(2);return[t-n,e-o].concat(r)}}}Number.isFinite===void 0&&(Number.isFinite=function(n){return typeof n=="number"&&isFinite(n)});var Ft=_t(6e5,2e5),Tt=Ft.apply,qt=Ft.unapply;var vt=_t(26e5,12e5),Pe=vt.apply,kt=vt.unapply;function St(n,o){var s=1/o,t=2*s-Math.pow(s,2);return{fromCartesian:function(e){var r,i,a,u,c,l=e[0],d=e[1],p=e[2],h=Math.atan(d/l),x=Math.sqrt(Math.pow(l,2)+Math.pow(d,2)),M=Math.atan(p/((1-t)*x));do r=i,a=u,u=n/Math.sqrt(1-t*Math.pow(Math.sin(M),2)),c=x/Math.cos(M)-u,M=Math.atan(p/((1-t*u/(u+c))*x)),i=Math.abs(u-a);while(isNaN(r)||i<r);var S=U(M);return[U(h),S,c]},toCartesian:function(e){var r=e[0],i=e[2],a=i===void 0?0:i,u=v(e[1]),c=v(r),l=n/Math.sqrt(1-t*Math.pow(Math.sin(u),2));return[(l+a)*Math.cos(u)*Math.cos(c),(l+a)*Math.cos(u)*Math.sin(c),(l*(1-t)+a)*Math.sin(u)]}}}var It=St(6377397155e-3,299.15281285),zt=It.fromCartesian,Yt=It.toCartesian,Ct=St(6378137,298.257223563),Qt=Ct.fromCartesian,Wt=Ct.toCartesian,xt=1/299.15281285,F=v(bt(46,57,8.66)),Dt=v(bt(7,26,22.5)),C=2*xt-Math.pow(xt,2),E=6377397155e-3*Math.sqrt(1-C)/(1-C*Math.pow(Math.sin(F),2)),w=Math.sqrt(1+C/(1-C)*Math.pow(Math.cos(F),4)),g=Math.asin(Math.sin(F)/w),y=Math.sqrt(C),Pt=Math.log(Math.tan(Math.PI/4+g/2))-w*Math.log(Math.tan(Math.PI/4+F/2))+w*y/2*Math.log((1+y*Math.sin(F))/(1-y*Math.sin(F)));function $t(n){var o,s=[(o=Wt(n))[0]-674.374,o[1]-15.056,o[2]-405.346],t=zt(s),e=function(r){var i=r[0],a=v(r[1]),u=v(i),c=w*Math.log(Math.tan(Math.PI/4+a/2))-w*y/2*Math.log((1+y*Math.sin(a))/(1-y*Math.sin(a)))+Pt,l=2*(Math.atan(Math.exp(c))-Math.PI/4),d=w*(u-Dt),p=Math.asin(Math.cos(g)*Math.sin(l)-Math.sin(g)*Math.cos(l)*Math.cos(d)),h=Math.atan(Math.sin(d)/(Math.sin(g)*Math.tan(l)+Math.cos(g)*Math.cos(d)));return[E*h,E/2*Math.log((1+Math.sin(p))/(1-Math.sin(p)))]}(t);return n.length>2?[].concat(e,[t[2]]):e}function Rt(n){var o=function(r){var i,a,u,c,l=r[0],d=2*(Math.atan(Math.exp(r[1]/E))-Math.PI/4),p=l/E,h=Math.asin(Math.cos(g)*Math.sin(d)+Math.sin(g)*Math.cos(d)*Math.cos(p)),x=Math.atan(Math.sin(p)/(Math.cos(g)*Math.cos(p)-Math.sin(g)*Math.tan(d))),M=Dt+x/w,S=h;do i=a,u=c,c=(Math.log(Math.tan(Math.PI/4+h/2))-Pt)/w+y*Math.log(Math.tan(Math.PI/4+Math.asin(y*Math.sin(S))/2)),S=2*Math.atan(Math.exp(c))-Math.PI/2,a=Math.abs(c-u);while(isNaN(i)||a<i);var Et=U(S);return[U(M),Et]}(n);o.push(n[2]);var s,t=[(s=Yt(o))[0]+674.374,s[1]+15.056,s[2]+405.346],e=Qt(t);return n.length>2?e:e.slice(0,2)}var jt={__proto__:null,project:function(n){return V(n),Tt($t(n))},unproject:function(n){return V(n),Rt(qt(n))}};function Ht(n){return V(n),Rt(kt(n))}var Nt=Ht;function Ot(n,o){let[s,t]=Nt([n,o]);return{latitude:t,longitude:s}}function Xt(n,o){let[s,t]=jt.unproject([n,o]);return{latitude:t,longitude:s}}var{namedNode:m,literal:G,defaultGraph:Ge,quad:Ae}=lt,Lt=m("http://www.w3.org/1999/02/22-rdf-syntax-ns#type");function Ut(n,o="https://www.stadt-zuerich.ch/resources/"){return f(this,null,function*(){let s={inst:o,cz:"https://www.stadt-zuerich.ch/terms#",geo:"http://www.opengis.net/ont/geosparql#",wgs:"http://www.w3.org/2003/01/geo/wgs84_pos#"},t=new dt({prefixes:s});for(let e of n.features){let r=JSON.stringify(e),a=(e.properties??{}).baumnummer;a!==void 0&&(r=`tree_${a}`);let c=`inst:${yield I(r)}`;t.addQuad(m(c),Lt,m("cz:Tree")),e.id!==void 0&&t.addQuad(m(c),m("cz:id"),G(e.id)),a!==void 0&&t.addQuad(m(c),m("cz:treeNumber"),G(a));let l=e.geometry;if(l!==void 0){let p=`inst:${yield I(`${r}_geo`)}`;t.addQuad(m(p),Lt,m("geo:Geometry")),t.addQuad(m(c),m("geo:hasGeometry"),m(p));let h=l.coordinates;h!==void 0&&h.length&&(t.addQuad(m(p),m("wgs:lng"),G(h[0])),t.addQuad(m(p),m("wgs:lat"),G(h[1])))}}return new Promise((e,r)=>{t.end((i,a)=>{i&&r(i),e(a)})})})}var en=(()=>{let o=class o{constructor(){this._dxfProcessor=q(ft),this._results=D(new N),this._resultsUpdated=D(0),this._processing=D(!1),this._tripleNamespace="https://www.stadt-zuerich.ch/resources/"}get results(){return this._results}get resultsUpdated(){return this._resultsUpdated}get processing(){return this._processing}set gisFeaturesSubset(t){let e=this._results();e.gisFeaturesSubset=t,this._updateResults(e)}setDXFSelection(t,e){return f(this,null,function*(){this._processing.set(!0);let r=yield this._buildGeoJSON(t,e),i=this._results();i.dxfFeatures=r,i.subsetDXF=this._dxfProcessor.extractSubset(t),i.dxfEntities=t,i.subsetDXFURL=this._createObjectURLFromString(i.subsetDXF),this._updateResults(i),this._processing.set(!1)})}uploadDXF(t=!0){return f(this,null,function*(){t&&console.time("Process DXF");let e=yield J(".dxf");this._processing.set(!0);let[r,i]=yield Promise.all([this._dxfProcessor.processDXF(e),ut(e)]),a=yield I(i),u=this._results();u.fullDXF=r,u.dxfMD5=i,u.dxfUUID=a,this._updateResults(u),t&&console.timeEnd("Process DXF"),this._processing.set(!1)})}uploadGeoJSON(){return f(this,null,function*(){let t=yield pt(".json,.geojson");if(this._processing.set(!0),t.bbox===void 0){let r=yt(t);r&&(t.bbox=r)}let e=this._results();e.gisFeatures=t,this._updateResults(e),this._processing.set(!1)})}matchDXFGisFeatures(t=1){return f(this,null,function*(){this._processing.set(!0);let e=this._results().dxfFeatures,r=this._results().gisFeatures;if(e===void 0){console.error("No DXF features available");return}if(r===void 0){console.error("No GIS features available");return}let i=yield mt(e,r,t),a=this._results();return a.pairingResults=i,this._updateResults(a),this._processing.set(!1),i})}downloadSubsetDXF(){this._processing.set(!0);let t=this._results().subsetDXF;if(t===void 0){console.error("No DXF available");return}_(t,"selection.dxf"),this._processing.set(!1)}downloadSelectedDXFAsGeoJSON(){return f(this,null,function*(){this._processing.set(!0);let t=this._results().dxfFeatures;if(t===void 0){console.error("No geoJSON from DXF available");return}O(t,"selection.geojson"),this._processing.set(!1)})}downloadDXFSubsetRDF(){return f(this,null,function*(){this._processing.set(!0);let t=this._results().dxfEntities,e=this._results().dxfUUID;if(t===void 0){console.error("No DXF selection available");return}if(e===void 0){console.error("DXF UUID not available");return}let r=yield this._dxfProcessor.buildASCollection(t,e,this._tripleNamespace);_(r,"dxf-subset.rdf"),this._processing.set(!1)})}downloadDXFTextsRDF(){return f(this,null,function*(){this._processing.set(!0);let t=this._results().dxfUUID;if(t===void 0){console.error("DXF UUID not available");return}let e=yield this._dxfProcessor.extractTextContent(t,this._tripleNamespace);_(e,"dxf-text.ttl"),this._processing.set(!1)})}downloadGISAsRDF(){return f(this,null,function*(){this._processing.set(!0);let t=this._results().gisFeatures;if(t===void 0){console.error("No geoJSON available");return}let e=yield Ut(t,this._tripleNamespace);_(e,"trees.ttl"),this._processing.set(!1)})}downloadMappings(){return f(this,null,function*(){let t=this._results().pairingResults;if(t===void 0){console.error("Pairing results not available");return}this._processing.set(!0);let e=t.successful.map(i=>i.connection),r=yield L(e,!1);r.properties={mappingDistance:t.threshold},O(r,"mapped.geojson"),this._processing.set(!1)})}downloadUnmapped(){return f(this,null,function*(){let t=this._results().pairingResults;if(t===void 0){console.error("Pairing results not available");return}this._processing.set(!0);let e=yield L(t.unsuccesful);e.properties={mappingDistance:t.threshold},O(e,"unmapped.geojson"),this._processing.set(!1)})}_buildGeoJSON(t,e){return f(this,null,function*(){let r=[];return t.forEach(i=>{if(i.position!==void 0){let a=0,u=0;if(e===b.LV95){let l=Ot(i.position.x,i.position.y);a=l.latitude,u=l.longitude}else if(e===b.LV03){let l=Xt(i.position.x,i.position.y);a=l.latitude,u=l.longitude}let c=wt([u,a],i);r.push(c)}}),L(r)})}_updateResults(t){this._results.set(t),this._resultsUpdated.set(new Date().getMilliseconds())}_createObjectURLFromString(t){let e=new Blob([t],{type:"text/plain"});return URL.createObjectURL(e)}};o.\u0275fac=function(e){return new(e||o)},o.\u0275prov=T({token:o,factory:o.\u0275fac,providedIn:"root"});let n=o;return n})();export{b as a,Ce as b,_ as c,At as d,ie as e,en as f};
